// Switched from SQLite â†’ PostgreSQL (Neon) for Vercel deployment
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Student {
  id               String    @id @default(cuid())
  name             String
  grade            Int       @default(4)
  createdAt        DateTime  @default(now())
  parentEmail      String?                       // for weekly email reports
  lastReportSentAt DateTime?                     // rate-limit on-demand sends
  progress         Progress[]
  attempts         Attempt[]
  chatSessions     ConversationSession[]
  mockTests        MockTest[]
}

model Topic {
  id            String     @id
  name          String
  chapterNumber String
  questions     Question[]
  progress      Progress[]
}

model Question {
  id             String    @id
  topicId        String
  topic          Topic     @relation(fields: [topicId], references: [id])
  subTopic       String
  difficulty     String    // "Easy" | "Medium" | "Hard"
  questionText   String
  questionLatex  String    @default("")
  option1        String
  option2        String
  option3        String
  option4        String
  correctAnswer  String    // "A" | "B" | "C" | "D"
  hint1          String    @default("")
  hint2          String    @default("")
  hint3          String    @default("")
  stepByStep     String    @default("[]") // JSON string
  misconceptionA String    @default("")
  misconceptionB String    @default("")
  misconceptionC String    @default("")
  misconceptionD String    @default("")
  source         String    @default("hand_crafted")
  year           Int?      // PYQ questions: 2016 | 2017 | 2018 | 2019
  questionNumber Int?      // PYQ questions: original exam order (1-40)
  attempts       Attempt[]
  mockTestResponses MockTestResponse[]

  @@index([topicId])
  @@index([topicId, difficulty])
}

model Progress {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  topicId   String
  topic     Topic    @relation(fields: [topicId], references: [id])
  attempted Int      @default(0)
  correct   Int      @default(0)
  mastery   String   @default("NotStarted") // "NotStarted" | "Practicing" | "Mastered"
  updatedAt DateTime @updatedAt

  @@unique([studentId, topicId])
}

model Attempt {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id])
  questionId  String
  question    Question @relation(fields: [questionId], references: [id])
  selected    String   // "A" | "B" | "C" | "D"
  isCorrect   Boolean
  hintUsed          Int      @default(0)
  timeTakenMs       Int      @default(0)
  misconceptionType String?  // misconception text shown when wrong, for adaptive boosting
  createdAt         DateTime @default(now())

  @@index([studentId])
  @@index([questionId])
  @@index([studentId, createdAt])
  @@index([studentId, misconceptionType])
}

model ConversationSession {
  id        String        @id @default(cuid())
  studentId String
  student   Student       @relation(fields: [studentId], references: [id])
  mode      String        @default("general") // "quiz"|"topic"|"homework"|"general"
  topicId   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  @@index([studentId])
}

model ChatMessage {
  id        String              @id @default(cuid())
  sessionId String
  session   ConversationSession @relation(fields: [sessionId], references: [id])
  role      String              // "user" | "assistant"
  content   String
  createdAt DateTime            @default(now())

  @@index([sessionId])
}

model MockTest {
  id             String             @id @default(cuid())
  studentId      String
  student        Student            @relation(fields: [studentId], references: [id])
  type           String             // "quick" | "half" | "full"
  totalQuestions Int
  timeLimitMs    Int
  startedAt      DateTime           @default(now())
  completedAt    DateTime?
  score          Int?
  accuracy       Float?
  status         String             @default("in_progress") // "in_progress" | "completed" | "abandoned"
  responses      MockTestResponse[]

  @@index([studentId])
  @@index([studentId, status])
}

model MockTestResponse {
  id             String    @id @default(cuid())
  mockTestId     String
  mockTest       MockTest  @relation(fields: [mockTestId], references: [id])
  questionId     String
  question       Question  @relation(fields: [questionId], references: [id])
  questionNumber Int
  selectedAnswer String?
  isCorrect      Boolean?
  timeTakenMs    Int       @default(0)
  flagged        Boolean   @default(false)
  answeredAt     DateTime?

  @@index([mockTestId])
  @@index([questionId])
}
