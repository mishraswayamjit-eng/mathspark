// Switched from SQLite → PostgreSQL (Neon) for Vercel deployment
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ── Parent (account holder, pays for subscription) ─────────────────────────

model Parent {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String
  name             String
  phone            String?
  resetToken       String?
  resetTokenExpiry DateTime?
  children         Student[]
  orders           Order[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// ── Subscription plans ─────────────────────────────────────────────────────

model Subscription {
  id                String    @id @default(cuid())
  name              String
  tier              Int
  priceINR          Int       // stored in paise (₹500 = 50000)
  durationDays      Int
  dailyLimitMinutes Int
  aiChatDailyLimit  Int
  features          String    // JSON blob
  isActive          Boolean   @default(true)
  students          Student[]
  orders            Order[]
}

// ── Student ────────────────────────────────────────────────────────────────

model Student {
  id                      String        @id @default(cuid())
  name                    String
  grade                   Int           @default(4)
  createdAt               DateTime      @default(now())
  parentEmail             String?                         // legacy — for weekly email reports
  lastReportSentAt        DateTime?                       // rate-limit on-demand sends
  // ── New parent/subscription fields ──
  parentId                String?
  parent                  Parent?       @relation(fields: [parentId], references: [id])
  subscriptionId          String?
  subscription            Subscription? @relation(fields: [subscriptionId], references: [id])
  dailyUsageMinutes       Int           @default(0)
  lastActiveDate          DateTime?
  aiChatMessagesUsedToday Int           @default(0)
  parentWhatsApp          String?                         // WhatsApp number for achievement shares
  // ── Gamification ──
  currentStreak           Int           @default(0)
  longestStreak           Int           @default(0)
  totalDaysPracticed      Int           @default(0)
  badges                  String        @default("[]") // JSON array of badge IDs
  // ── League / Social ──
  displayName             String?
  avatarColor             String        @default("#3B82F6")
  currentLeagueTier       Int           @default(1)
  totalLifetimeXP         Int           @default(0)
  hiddenFromLeaderboard   Boolean       @default(false)
  // ── Brain Engine / Personalization ──
  trialExpiresAt          DateTime?
  examName                String?
  examDate                DateTime?
  dailyGoalMins           Int           @default(20)
  targetScore             Int?
  focusTopics             String        @default("[]")   // JSON: string[] topicIds
  confidentTopics         String        @default("[]")   // JSON: string[] topicIds
  city                    String?
  preferredPracticeTime   String?       // "morning"|"afternoon"|"evening"
  sessionLengthMins       Int           @default(15)
  analytics               StudentAnalytics?
  // ── Relations ──
  progress                Progress[]
  attempts                Attempt[]
  chatSessions            ConversationSession[]
  mockTests               MockTest[]
  usageLogs               UsageLog[]
  orders                  Order[]
  leagueMemberships       LeagueMembership[]
  weeklyAwards            WeeklyAward[]
}

// ── Order (payment record) ─────────────────────────────────────────────────

model Order {
  id                String       @id @default(cuid())
  parentId          String
  parent            Parent       @relation(fields: [parentId], references: [id])
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id])
  studentId         String
  student           Student      @relation(fields: [studentId], references: [id])
  amountPaise       Int
  currency          String       @default("INR")
  paymentMethod     String
  paymentStatus     String       // "pending" | "paid" | "failed"
  razorpayOrderId   String?
  razorpayPaymentId String?
  invoiceNumber     String       @unique
  receiptUrl        String?
  startsAt          DateTime
  expiresAt         DateTime
  createdAt         DateTime     @default(now())

  @@index([parentId])
  @@index([studentId])
}

// ── Usage tracking ─────────────────────────────────────────────────────────

model UsageLog {
  id                 String   @id @default(cuid())
  studentId          String
  student            Student  @relation(fields: [studentId], references: [id])
  date               DateTime @db.Date
  minutesUsed        Int      @default(0)
  questionsAttempted Int      @default(0)
  aiChatMessages     Int      @default(0)
  xpEarned           Int      @default(0)

  @@unique([studentId, date])
}

// ── Topic ──────────────────────────────────────────────────────────────────

model Topic {
  id            String     @id
  name          String
  chapterNumber String
  grade         Int        @default(4)   // 2-9; ch-series and dh = 4
  questions     Question[]
  progress      Progress[]
}

// ── Question ───────────────────────────────────────────────────────────────

model Question {
  id             String    @id
  topicId        String
  topic          Topic     @relation(fields: [topicId], references: [id])
  subTopic       String
  difficulty     String    // "Easy" | "Medium" | "Hard"
  questionText   String
  questionLatex  String    @default("")
  option1        String
  option2        String
  option3        String
  option4        String
  correctAnswer  String    // "A" | "B" | "C" | "D"
  hint1          String    @default("")
  hint2          String    @default("")
  hint3          String    @default("")
  stepByStep     String    @default("[]") // JSON string
  misconceptionA String    @default("")
  misconceptionB String    @default("")
  misconceptionC String    @default("")
  misconceptionD String    @default("")
  source         String    @default("hand_crafted")
  year           Int?      // PYQ questions: 2016 | 2017 | 2018 | 2019
  questionNumber Int?      // PYQ questions: original exam order (1-40)
  attempts       Attempt[]
  mockTestResponses MockTestResponse[]

  @@index([topicId])
  @@index([topicId, difficulty])
}

// ── Progress ───────────────────────────────────────────────────────────────

model Progress {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  topicId   String
  topic     Topic    @relation(fields: [topicId], references: [id])
  attempted Int      @default(0)
  correct   Int      @default(0)
  mastery   String   @default("NotStarted") // "NotStarted" | "Practicing" | "Mastered"
  updatedAt DateTime @updatedAt

  @@unique([studentId, topicId])
}

// ── Attempt ────────────────────────────────────────────────────────────────

model Attempt {
  id                String   @id @default(cuid())
  studentId         String
  student           Student  @relation(fields: [studentId], references: [id])
  questionId        String
  question          Question @relation(fields: [questionId], references: [id])
  selected          String   // "A" | "B" | "C" | "D"
  isCorrect         Boolean
  hintUsed          Int      @default(0)
  timeTakenMs       Int      @default(0)
  misconceptionType    String?
  watchedWalkthrough   Boolean  @default(false)
  isBonusQuestion      Boolean  @default(false)
  parentQuestionId     String?
  createdAt            DateTime @default(now())

  @@index([studentId])
  @@index([questionId])
  @@index([studentId, createdAt])
  @@index([studentId, misconceptionType])
}

// ── Chat ───────────────────────────────────────────────────────────────────

model ConversationSession {
  id        String        @id @default(cuid())
  studentId String
  student   Student       @relation(fields: [studentId], references: [id])
  mode      String        @default("general") // "quiz"|"topic"|"homework"|"general"
  topicId   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  @@index([studentId])
}

model ChatMessage {
  id        String              @id @default(cuid())
  sessionId String
  session   ConversationSession @relation(fields: [sessionId], references: [id])
  role      String              // "user" | "assistant"
  content   String
  createdAt DateTime            @default(now())

  @@index([sessionId])
}

// ── Mock Tests ─────────────────────────────────────────────────────────────

model MockTest {
  id             String             @id @default(cuid())
  studentId      String
  student        Student            @relation(fields: [studentId], references: [id])
  type           String             // "quick" | "half" | "full" | "ipm" | "pyq"
  totalQuestions Int
  timeLimitMs    Int
  startedAt      DateTime           @default(now())
  completedAt    DateTime?
  score          Int?
  accuracy       Float?
  status         String             @default("in_progress") // "in_progress" | "completed" | "abandoned"
  responses      MockTestResponse[]

  @@index([studentId])
  @@index([studentId, status])
}

model MockTestResponse {
  id             String    @id @default(cuid())
  mockTestId     String
  mockTest       MockTest  @relation(fields: [mockTestId], references: [id])
  questionId     String
  question       Question  @relation(fields: [questionId], references: [id])
  questionNumber Int
  selectedAnswer String?
  isCorrect      Boolean?
  timeTakenMs    Int       @default(0)
  flagged        Boolean   @default(false)
  answeredAt     DateTime?

  @@index([mockTestId])
  @@index([questionId])
}

// ── Student Analytics (Brain Engine output) ────────────────────────────────

model StudentAnalytics {
  id              String   @id @default(cuid())
  studentId       String   @unique
  student         Student  @relation(fields: [studentId], references: [id])
  topicMastery    Json?    // TopicMasteryEntry[]
  examReadiness   Json?    // ExamReadinessResult
  topicPriorities Json?    // TopicPriority[]
  dailyPlan       Json?    // DailyPlanItem[]
  nudges          Json?    // Nudge[]
  lastComputedAt  DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ── League / Social ────────────────────────────────────────────────────────

model League {
  id        String             @id @default(cuid())
  name      String             // "Bronze" | "Silver" | "Gold" | "Diamond" | "Champion"
  tier      Int                // 1–5
  grade     Int                @default(4)  // students compete within same grade
  weekStart DateTime           // Monday 00:00 IST expressed as UTC
  weekEnd   DateTime           // Sunday 23:59:59 IST expressed as UTC
  members   LeagueMembership[]

  @@index([tier, grade, weekStart])
}

model LeagueMembership {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id])
  leagueId  String
  league    League  @relation(fields: [leagueId], references: [id])
  weeklyXP  Int     @default(0)
  rank      Int?                // null during week; set by cron at week-end
  promoted  Boolean @default(false)
  demoted   Boolean @default(false)

  @@unique([studentId, leagueId])
  @@index([leagueId, weeklyXP])
}

model WeeklyAward {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  weekStart DateTime
  awardType String   // "most_improved" | "speed_demon" | "accuracy_king" | "explorer"
  value     String   // e.g. "+240 XP jump", "avg 7s", "94% accuracy", "8 topics"

  @@index([weekStart])
  @@index([studentId])
}
